<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Connection Bridge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for message history */
        .message-history::-webkit-scrollbar {
            width: 6px;
        }
        .message-history::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        /* Mobile-first centering */
        .container-center {
            max-width: 600px;
        }
        /* Custom styles for mobile touch targets */
        button, input[type="text"] {
            min-height: 48px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center py-8 px-4">

    <div id="app" class="w-full container-center bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col h-[90vh] max-h-[800px]">
        
        <!-- Header -->
        <header class="p-4 bg-blue-600 text-white shadow-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5-3h8M3 4h18M3 8h18m-6 4h.01M3 16h18"/>
                </svg>
                <h1 class="text-xl font-bold">Remote Connection Bridge</h1>
            </div>
        </header>

        <!-- Connection Info and Status -->
        <div class="p-4 border-b border-gray-200 bg-gray-50">
            <div id="status-message" class="text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-yellow-100 text-yellow-700">
                Awaiting connection on local network...
            </div>
            <p class="mt-2 text-xs text-gray-500 text-center">Open this same URL on your other device (laptop/phone) to attempt a connection.</p>
            <div class="mt-3 flex justify-center items-center space-x-2">
                <span class="text-xs font-semibold text-gray-700">Device ID:</span>
                <span id="device-id" class="text-sm font-mono text-blue-800 bg-blue-100 px-3 py-1 rounded-full cursor-pointer hover:bg-blue-200 transition"></span>
            </div>
        </div>
        
        <!-- Message History (Main Content Area) -->
        <main class="flex-grow p-4 overflow-y-auto message-history space-y-3">
            <!-- Messages will be appended here -->
            <div class="text-center text-sm text-gray-500 pt-2">
                Connection established. You can now send messages to the paired device.
            </div>
        </main>

        <!-- Input Form -->
        <footer class="p-4 border-t border-gray-200 bg-white">
            <form id="send-form" class="flex space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Send data or command..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm outline-none text-gray-700"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-transform active:scale-95 disabled:bg-gray-400 flex items-center justify-center"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <span class="ml-1 hidden sm:inline">Send</span>
                </button>
            </form>
        </footer>
    </div>

    <script>
        const deviceIdEl = document.getElementById('device-id');
        const statusEl = document.getElementById('status-message');
        const mainEl = document.querySelector('main');
        const sendForm = document.getElementById('send-form');
        const messageInput = document.getElementById('message-input');
        
        let localDeviceId = localStorage.getItem('deviceId');
        if (!localDeviceId) {
            localDeviceId = 'DEV-' + Math.random().toString(36).substring(2, 9).toUpperCase();
            localStorage.setItem('deviceId', localDeviceId);
        }
        deviceIdEl.textContent = localDeviceId;

        // --- Mock WebSocket Implementation ---
        // Since true WebSockets cannot be established in this sandbox,
        // we use localStorage as a secure, fast, and accessible "local broadcast" channel
        // to simulate the real-time data exchange between two browser tabs/windows
        // (your phone and laptop, provided they access the same URL).

        const CHANNEL_KEY = 'device-bridge-channel';

        /**
         * Simulates sending a message across the "network" (localStorage).
         * @param {string} content - The message content.
         */
        function sendMessage(content) {
            const message = {
                senderId: localDeviceId,
                content: content,
                timestamp: new Date().toLocaleTimeString(),
                type: 'data'
            };
            
            // Append message locally immediately
            appendMessage(message, true); 

            // Simulate broadcasting the message to the other device
            // We store it as a stringified object to signal the change
            localStorage.setItem(CHANNEL_KEY, JSON.stringify(message));
            
            // Clean up the broadcast trigger key immediately so it only fires once
            setTimeout(() => {
                localStorage.removeItem(CHANNEL_KEY);
            }, 100);
        }

        /**
         * Appends a message bubble to the chat history.
         * @param {object} message - The message object.
         * @param {boolean} isLocalSender - True if the message was sent from this device.
         */
        function appendMessage(message, isLocalSender) {
            const bubble = document.createElement('div');
            
            const alignment = isLocalSender ? 'justify-end' : 'justify-start';
            const bgColor = isLocalSender ? 'bg-blue-500' : 'bg-gray-200';
            const textColor = isLocalSender ? 'text-white' : 'text-gray-800';
            const cornerClass = isLocalSender ? 'rounded-br-none' : 'rounded-bl-none';

            bubble.className = `flex ${alignment} mb-3`;
            bubble.innerHTML = `
                <div class="max-w-[80%] p-3 ${bgColor} ${textColor} rounded-xl ${cornerClass} shadow-md transition break-words">
                    <p class="text-xs font-semibold ${isLocalSender ? 'text-blue-100' : 'text-gray-600'} mb-1">
                        ${isLocalSender ? 'You' : `Paired Device (${message.senderId.substring(0, 7)}...)`}
                    </p>
                    <p class="text-base">${message.content}</p>
                    <p class="text-[10px] opacity-70 mt-1 text-right">${message.timestamp}</p>
                </div>
            `;
            mainEl.appendChild(bubble);
            mainEl.scrollTop = mainEl.scrollHeight; // Auto-scroll to bottom
        }

        /**
         * Handles incoming "network" messages broadcast via localStorage.
         */
        function handleStorageChange(event) {
            if (event.key !== CHANNEL_KEY || !event.newValue) return;

            try {
                const receivedMessage = JSON.parse(event.newValue);
                
                // Ignore messages sent by this device
                if (receivedMessage.senderId === localDeviceId) {
                    // Update status for the sender to show message was sent successfully
                    updateStatus('Data sent successfully!', 'bg-green-100 text-green-700');
                    return;
                }

                // Append the incoming message from the paired device
                appendMessage(receivedMessage, false);

                // Update status for the receiver
                updateStatus(`Received data from ${receivedMessage.senderId.substring(0, 7)}...`, 'bg-green-100 text-green-700');

            } catch (e) {
                console.error("Error parsing received message:", e);
            }
        }
        
        /**
         * Updates the status banner with a temporary message.
         */
        function updateStatus(message, className) {
            const originalClass = statusEl.className;
            const originalText = statusEl.textContent;
            
            statusEl.className = `text-sm font-medium p-2 rounded-lg text-center transition duration-300 ${className}`;
            statusEl.textContent = message;

            // Revert status after a delay
            setTimeout(() => {
                statusEl.className = originalClass;
                statusEl.textContent = originalText;
            }, 3000);
        }

        // --- Event Listeners and Initialization ---

        // 1. Listen for incoming messages from the paired device
        window.addEventListener('storage', handleStorageChange);

        // 2. Handle form submission to send a message
        sendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
                messageInput.value = ''; // Clear input
            }
        });

        // 3. Initial connection status check
        window.onload = () => {
             // In a real app, this is where you'd attempt a WebSocket connection 
             // using the local network IP address, but here we confirm the local bridge is ready.
             statusEl.className = 'text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-green-100 text-green-700';
             statusEl.innerHTML = 'Bridge Ready. <span class="font-bold">Pairing active.</span>';
        };

        // Cleanup: Important for proper simulation
        window.addEventListener('beforeunload', () => {
             window.removeEventListener('storage', handleStorageChange);
        });

    </script>
</body>
</html>

