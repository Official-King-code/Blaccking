<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Connection Bridge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for message history */
        .message-history::-webkit-scrollbar {
            width: 6px;
        }
        .message-history::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        /* Mobile-first centering */
        .container-center {
            max-width: 600px;
        }
        /* Custom styles for mobile touch targets */
        button, input[type="text"] {
            min-height: 48px;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for the main script
        window.FirebaseServices = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center py-8 px-4">

    <div id="app" class="w-full container-center bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col h-[90vh] max-h-[800px]">
        
        <!-- Header -->
        <header class="p-4 bg-blue-600 text-white shadow-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5-3h8M3 4h18M3 8h18m-6 4h.01M3 16h18"/>
                </svg>
                <h1 class="text-xl font-bold">Remote Connection Bridge</h1>
            </div>
        </header>

        <!-- Connection Info and Status -->
        <div class="p-4 border-b border-gray-200 bg-gray-50">
            <div id="status-message" class="text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-yellow-100 text-yellow-700">
                Initializing Firebase...
            </div>
            
            <div class="mt-3 flex justify-center items-center space-x-2">
                <span class="text-xs font-semibold text-gray-700">Your ID:</span>
                <span id="device-id" class="text-sm font-mono text-blue-800 bg-blue-100 px-3 py-1 rounded-full select-all"></span>
            </div>
            
            <!-- Pairing Input -->
            <form id="pair-form" class="mt-4 flex space-x-2">
                <input
                    type="text"
                    id="target-id-input"
                    placeholder="Enter Target Device ID (e.g., DEV-ABC1234)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition shadow-sm outline-none text-gray-700"
                    required
                >
                <button
                    type="submit"
                    id="pair-button"
                    class="bg-green-600 text-white px-5 py-2 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-transform active:scale-95 disabled:bg-gray-400 flex items-center justify-center"
                    disabled
                >
                    Pair
                </button>
            </form>
            <p id="pairing-info" class="mt-2 text-xs text-gray-500 text-center hidden">
                Currently paired with: <span id="paired-id" class="font-semibold text-gray-700">None</span>
            </p>
        </div>
        
        <!-- Message History (Main Content Area) -->
        <main class="flex-grow p-4 overflow-y-auto message-history space-y-3">
            <div id="initial-message" class="text-center text-sm text-gray-500 pt-2">
                Enter a Target Device ID above and click 'Pair' to begin communication.
            </div>
        </main>

        <!-- Input Form -->
        <footer class="p-4 border-t border-gray-200 bg-white">
            <form id="send-form" class="flex space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Send data or command..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm outline-none text-gray-700"
                    required
                    disabled
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-transform active:scale-95 disabled:bg-gray-400 flex items-center justify-center"
                    disabled
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <span class="ml-1 hidden sm:inline">Send</span>
                </button>
            </form>
        </footer>
    </div>

    <script type="module">
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel
        } = window.FirebaseServices;

        // UI Elements
        const deviceIdEl = document.getElementById('device-id');
        const statusEl = document.getElementById('status-message');
        const mainEl = document.querySelector('main');
        const sendForm = document.getElementById('send-form');
        const messageInput = document.getElementById('message-input');
        const pairForm = document.getElementById('pair-form');
        const targetIdInput = document.getElementById('target-id-input');
        const pairButton = document.getElementById('pair-button');
        const sendButton = document.getElementById('send-button');
        const pairingInfoEl = document.getElementById('pairing-info');
        const pairedIdEl = document.getElementById('paired-id');
        const initialMessageEl = document.getElementById('initial-message');

        // Global State
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let localDeviceId = 'DEV-' + Math.random().toString(36).substring(2, 9).toUpperCase();
        deviceIdEl.textContent = localDeviceId;
        
        let db, auth;
        let userId;
        let pairedTargetId = null;
        let unsubscribeMessageListener = null;

        // --- Firebase Initialization and Auth ---
        
        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Use for debugging, uncomment if needed
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                statusEl.textContent = 'Authenticating...';

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusEl.className = 'text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-green-100 text-green-700';
                        statusEl.textContent = 'Connected to Internet Bridge.';
                        pairButton.disabled = false;
                        // Since we are using a public collection path, userId is not strictly necessary for pathing,
                        // but it confirms we are authenticated.
                    } else {
                        statusEl.className = 'text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-red-100 text-red-700';
                        statusEl.textContent = 'Authentication Failed. Cannot connect.';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                statusEl.className = 'text-sm font-medium p-2 rounded-lg text-center transition duration-300 bg-red-100 text-red-700';
                statusEl.textContent = 'CRITICAL ERROR: Failed to connect to database.';
            }
        }

        // --- Messaging Logic ---

        function getMessageCollection(targetId) {
            // Public collection path: /artifacts/{appId}/public/data/connections/{targetId}/messages
            // The targetId acts as the unique channel ID for two-way communication.
            const channelPath = `/artifacts/${appId}/public/data/connections/${targetId}`;
            return collection(db, channelPath, 'messages');
        }

        /**
         * Clears listeners and establishes a new real-time connection to a target ID.
         * @param {string} targetId - The ID of the device to connect to.
         */
        function startPairing(targetId) {
            if (unsubscribeMessageListener) {
                unsubscribeMessageListener(); // Stop listening to the previous channel
            }
            
            pairedTargetId = targetId;
            mainEl.innerHTML = ''; // Clear chat history
            initialMessageEl.classList.add('hidden'); // Hide instruction

            const messagesRef = getMessageCollection(targetId);
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            unsubscribeMessageListener = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        // Only display messages where the current device is the sender OR the intended target.
                        // Since we use the TARGET ID as the channel name, we display all messages written to that channel.
                        appendMessage(message, message.senderId === localDeviceId);
                    }
                });
            }, (error) => {
                console.error("Error listening to messages:", error);
                updateStatus('Real-time connection lost.', 'bg-red-100 text-red-700');
            });

            // Update UI for active pairing
            pairedIdEl.textContent = pairedTargetId;
            pairingInfoEl.classList.remove('hidden');
            messageInput.disabled = false;
            sendButton.disabled = false;
            updateStatus(`Paired with ${targetId}! Start sending data.`, 'bg-blue-100 text-blue-700');
        }

        /**
         * Sends a message to the currently paired target device via Firestore.
         * @param {string} content - The message content.
         */
        async function sendMessage(content) {
            if (!pairedTargetId || !db) {
                updateStatus('Not paired. Please enter an ID to pair.', 'bg-red-100 text-red-700');
                return;
            }

            const message = {
                senderId: localDeviceId,
                content: content,
                timestamp: serverTimestamp(), // Use Firestore timestamp
                type: 'data'
            };

            try {
                // Send message to the target's channel (pairedTargetId)
                await addDoc(getMessageCollection(pairedTargetId), message);
                updateStatus('Data sent successfully!', 'bg-green-100 text-green-700');
            } catch (e) {
                console.error("Error sending message:", e);
                updateStatus('Failed to send data (Check Firewall/Rules).', 'bg-red-100 text-red-700');
            }
        }

        /**
         * Appends a message bubble to the chat history.
         */
        function appendMessage(message, isLocalSender) {
            // Note: Timestamp might be a Firestore Timestamp object or null initially, so format carefully.
            const time = message.timestamp?.toDate ? message.timestamp.toDate().toLocaleTimeString() : '...';
            
            const bubble = document.createElement('div');
            
            const alignment = isLocalSender ? 'justify-end' : 'justify-start';
            const bgColor = isLocalSender ? 'bg-blue-500' : 'bg-gray-200';
            const textColor = isLocalSender ? 'text-white' : 'text-gray-800';
            const cornerClass = isLocalSender ? 'rounded-br-none' : 'rounded-bl-none';

            bubble.className = `flex ${alignment} mb-3`;
            bubble.innerHTML = `
                <div class="max-w-[80%] p-3 ${bgColor} ${textColor} rounded-xl ${cornerClass} shadow-md transition break-words">
                    <p class="text-xs font-semibold ${isLocalSender ? 'text-blue-100' : 'text-gray-600'} mb-1">
                        ${isLocalSender ? 'You' : `From ${message.senderId}`}
                    </p>
                    <p class="text-base">${message.content}</p>
                    <p class="text-[10px] opacity-70 mt-1 text-right">${time}</p>
                </div>
            `;
            mainEl.appendChild(bubble);
            mainEl.scrollTop = mainEl.scrollHeight; // Auto-scroll to bottom
        }

        /**
         * Updates the status banner with a temporary message.
         */
        function updateStatus(message, className) {
            statusEl.className = `text-sm font-medium p-2 rounded-lg text-center transition duration-300 ${className}`;
            statusEl.textContent = message;
        }

        // --- Event Listeners and Initialization ---

        // 1. Handle form submission to send a message
        sendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && !sendButton.disabled) {
                sendMessage(message);
                messageInput.value = ''; // Clear input
            }
        });

        // 2. Handle pairing form submission
        pairForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const targetId = targetIdInput.value.trim().toUpperCase();
            if (targetId && targetId !== localDeviceId) {
                startPairing(targetId);
                targetIdInput.value = '';
            } else if (targetId === localDeviceId) {
                updateStatus('You cannot pair with your own device ID!', 'bg-red-100 text-red-700');
            }
        });

        // 3. Initial Firebase Setup
        window.onload = initializeFirebase;

        // Cleanup
        window.addEventListener('beforeunload', () => {
             if (unsubscribeMessageListener) {
                 unsubscribeMessageListener();
             }
        });

    </script>
</body>
</html>

